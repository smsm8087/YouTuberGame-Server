@page "/rewards"
@inject AdminAuthService AuthService
@inject AdminApiClient ApiClient
@inject NavigationManager Navigation

<PageTitle>ë³´ìƒ ì§€ê¸‰</PageTitle>

@if (!AuthService.IsAuthenticated)
{
    <p>ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤...</p>
    return;
}

<h1>ğŸ ë³´ìƒ ì§€ê¸‰</h1>

<div class="card mt-4">
    <div class="card-body">
        <h5 class="card-title">ì „ì²´ ìœ ì €ì—ê²Œ ë³´ìƒ ì§€ê¸‰</h5>

        @if (!string.IsNullOrEmpty(resultMessage))
        {
            <div class="alert @(resultSuccess ? "alert-success" : "alert-danger")" role="alert">
                @resultMessage
            </div>
        }

        <div class="row">
            <div class="col-md-4">
                <div class="mb-3">
                    <label class="form-label">ê³¨ë“œ</label>
                    <input type="number" class="form-control" @bind="rewardGold" />
                </div>
            </div>

            <div class="col-md-4">
                <div class="mb-3">
                    <label class="form-label">ì ¬</label>
                    <input type="number" class="form-control" @bind="rewardGem" />
                </div>
            </div>

            <div class="col-md-4">
                <div class="mb-3">
                    <label class="form-label">ê²½í—˜ì¹˜ ì¹©</label>
                    <input type="number" class="form-control" @bind="rewardExpChips" />
                </div>
            </div>
        </div>

        <div class="mb-3">
            <label class="form-label">ì§€ê¸‰ ì‚¬ìœ </label>
            <input type="text" class="form-control" @bind="rewardReason" placeholder="ì˜ˆ: ì„œë²„ ì ê²€ ë³´ìƒ" />
        </div>

        <div class="mb-3">
            <label class="form-label">ëŒ€ìƒ ìœ ì € ID (ì„ íƒì‚¬í•­)</label>
            <textarea class="form-control" rows="3" @bind="targetUserIds" placeholder="ë¹„ì›Œë‘ë©´ ì „ì²´ ìœ ì €ì—ê²Œ ì§€ê¸‰ë©ë‹ˆë‹¤.&#10;íŠ¹ì • ìœ ì €ì—ê²Œë§Œ ì§€ê¸‰í•˜ë ¤ë©´ UserIdë¥¼ ì‰¼í‘œë¡œ êµ¬ë¶„í•˜ì—¬ ì…ë ¥í•˜ì„¸ìš”."></textarea>
            <small class="text-muted">ì˜ˆ: user1,user2,user3</small>
        </div>

        <button class="btn btn-primary" @onclick="SendReward" disabled="@isSending">
            @if (isSending)
            {
                <span>ì§€ê¸‰ ì¤‘...</span>
            }
            else
            {
                <span>ë³´ìƒ ì§€ê¸‰</span>
            }
        </button>
    </div>
</div>

<div class="card mt-4">
    <div class="card-body">
        <h5 class="card-title">âš ï¸ ì£¼ì˜ì‚¬í•­</h5>
        <ul>
            <li>ë³´ìƒ ì§€ê¸‰ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</li>
            <li>ì „ì²´ ìœ ì €ì—ê²Œ ì§€ê¸‰í•˜ëŠ” ê²½ìš°, ë°ì´í„°ë² ì´ìŠ¤ì˜ ëª¨ë“  ìœ ì €ê°€ ëŒ€ìƒì…ë‹ˆë‹¤.</li>
            <li>ìŒìˆ˜ ê°’ì„ ì…ë ¥í•˜ë©´ í•´ë‹¹ ì¬í™”ë¥¼ ì°¨ê°í•©ë‹ˆë‹¤.</li>
            <li>ì§€ê¸‰ ì‚¬ìœ ëŠ” ë¡œê·¸ì— ê¸°ë¡ë©ë‹ˆë‹¤.</li>
        </ul>
    </div>
</div>

@code {
    private long rewardGold = 0;
    private long rewardGem = 0;
    private int rewardExpChips = 0;
    private string rewardReason = "";
    private string targetUserIds = "";
    private bool isSending = false;
    private string resultMessage = "";
    private bool resultSuccess = false;

    protected override void OnInitialized()
    {
        if (!AuthService.IsAuthenticated)
        {
            Navigation.NavigateTo("/login");
        }
    }

    private async Task SendReward()
    {
        if (string.IsNullOrEmpty(rewardReason))
        {
            resultMessage = "ì§€ê¸‰ ì‚¬ìœ ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.";
            resultSuccess = false;
            return;
        }

        if (rewardGold == 0 && rewardGem == 0 && rewardExpChips == 0)
        {
            resultMessage = "ì§€ê¸‰í•  ì¬í™”ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.";
            resultSuccess = false;
            return;
        }

        isSending = true;
        resultMessage = "";

        var request = new SendRewardRequest
            {
                Gold = rewardGold,
                Gem = rewardGem,
                ExpChips = rewardExpChips,
                RewardReason = rewardReason,
                TargetUserIds = string.IsNullOrEmpty(targetUserIds)
                    ? new List<string>()
                    : targetUserIds.Split(',').Select(x => x.Trim()).ToList()
            };

        var response = await ApiClient.SendRewardAsync(request);

        isSending = false;

        if (response != null && response.Success)
        {
            resultMessage = response.Message;
            resultSuccess = true;

            // í¼ ì´ˆê¸°í™”
            rewardGold = 0;
            rewardGem = 0;
            rewardExpChips = 0;
            rewardReason = "";
            targetUserIds = "";
        }
        else
        {
            resultMessage = response?.Message ?? "ë³´ìƒ ì§€ê¸‰ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.";
            resultSuccess = false;
        }
    }
}
