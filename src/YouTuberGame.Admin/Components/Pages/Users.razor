@page "/users"
@inject AdminAuthService AuthService
@inject AdminApiClient ApiClient
@inject NavigationManager Navigation

<PageTitle>ìœ ì € ê´€ë¦¬</PageTitle>

@if (!AuthService.IsAuthenticated)
{
    <p>ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤...</p>
    return;
}

<h1>ğŸ‘¤ ìœ ì € ê´€ë¦¬</h1>

<div class="row mt-3 mb-3">
    <div class="col-md-6">
        <div class="input-group">
            <input type="text" class="form-control" placeholder="ì´ë©”ì¼, í”Œë ˆì´ì–´ëª…, ì±„ë„ëª… ê²€ìƒ‰" @bind="searchQuery" @bind:event="oninput" />
            <button class="btn btn-primary" @onclick="SearchUsers">ê²€ìƒ‰</button>
        </div>
    </div>
</div>

@if (userList == null)
{
    <p><em>ë°ì´í„° ë¡œë”© ì¤‘...</em></p>
}
else
{
    <p>ì´ <strong>@userList.TotalCount</strong>ëª…ì˜ ìœ ì €</p>

    <table class="table table-hover">
        <thead>
            <tr>
                <th>ì´ë©”ì¼</th>
                <th>í”Œë ˆì´ì–´ëª…</th>
                <th>ì±„ë„ëª…</th>
                <th>ê³¨ë“œ</th>
                <th>ì ¬</th>
                <th>êµ¬ë…ì</th>
                <th>ê°€ì…ì¼</th>
                <th>ìµœì¢… ë¡œê·¸ì¸</th>
                <th>ì•¡ì…˜</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var user in userList.Users)
            {
                <tr>
                    <td>@user.Email</td>
                    <td>@user.PlayerName</td>
                    <td>@user.ChannelName</td>
                    <td>@user.Gold.ToString("N0")</td>
                    <td>@user.Gem</td>
                    <td>@user.Subscribers.ToString("N0")</td>
                    <td>@user.CreatedAt.ToString("yyyy-MM-dd")</td>
                    <td>@user.LastLoginAt.ToString("yyyy-MM-dd HH:mm")</td>
                    <td>
                        <button class="btn btn-sm btn-info" @onclick="() => ViewUserDetail(user.UserId)">ìƒì„¸</button>
                        <button class="btn btn-sm btn-warning" @onclick="() => ShowEditCurrency(user)">ì¬í™” ìˆ˜ì •</button>
                    </td>
                </tr>
            }
        </tbody>
    </table>

    <nav>
        <ul class="pagination">
            @for (int i = 1; i <= Math.Ceiling((double)userList.TotalCount / 50); i++)
            {
                var pageNum = i;
                <li class="page-item @(currentPage == pageNum ? "active" : "")">
                    <a class="page-link" @onclick="() => LoadPage(pageNum)">@pageNum</a>
                </li>
            }
        </ul>
    </nav>
}

@if (selectedUser != null && showEditModal)
{
    <div class="modal show d-block" tabindex="-1" role="dialog" style="background: rgba(0,0,0,0.5);">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">ì¬í™” ìˆ˜ì • - @selectedUser.PlayerName</h5>
                    <button type="button" class="btn-close" @onclick="CloseEditModal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">ê³¨ë“œ ë³€ê²½ëŸ‰ (+ ë˜ëŠ” -)</label>
                        <input type="number" class="form-control" @bind="editGold" />
                        <small class="text-muted">í˜„ì¬: @selectedUser.Gold</small>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">ì ¬ ë³€ê²½ëŸ‰ (+ ë˜ëŠ” -)</label>
                        <input type="number" class="form-control" @bind="editGem" />
                        <small class="text-muted">í˜„ì¬: @selectedUser.Gem</small>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">ì‚¬ìœ </label>
                        <input type="text" class="form-control" @bind="editReason" />
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CloseEditModal">ì·¨ì†Œ</button>
                    <button type="button" class="btn btn-primary" @onclick="SaveCurrencyEdit">ì €ì¥</button>
                </div>
            </div>
        </div>
    </div>
}

@if (selectedUserDetail != null && showDetailModal)
{
    <div class="modal show d-block" tabindex="-1" role="dialog" style="background: rgba(0,0,0,0.5);">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">ìœ ì € ìƒì„¸ - @selectedUserDetail.User.PlayerName</h5>
                    <button type="button" class="btn-close" @onclick="CloseDetailModal"></button>
                </div>
                <div class="modal-body">
                    <h6>ê¸°ë³¸ ì •ë³´</h6>
                    <p>ì´ë©”ì¼: @selectedUserDetail.User.Email</p>
                    <p>ì±„ë„ëª…: @selectedUserDetail.User.ChannelName</p>
                    <p>ê³¨ë“œ: @selectedUserDetail.User.Gold | ì ¬: @selectedUserDetail.User.Gem | êµ¬ë…ì: @selectedUserDetail.User.Subscribers</p>

                    <h6 class="mt-3">ë³´ìœ  ìºë¦­í„° (@(selectedUserDetail.Characters.Count)ê°œ)</h6>
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>ì´ë¦„</th>
                                <th>ë“±ê¸‰</th>
                                <th>ë ˆë²¨</th>
                                <th>ëŒíŒŒ</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var character in selectedUserDetail.Characters)
                            {
                                <tr>
                                    <td>@character.CharacterName</td>
                                    <td>@character.Rarity</td>
                                    <td>@character.Level</td>
                                    <td>@character.Breakthrough</td>
                                </tr>
                            }
                        </tbody>
                    </table>

                    <h6 class="mt-3">ì½˜í…ì¸  íˆìŠ¤í† ë¦¬ (@(selectedUserDetail.ContentHistory.Count)ê°œ)</h6>
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>ì œëª©</th>
                                <th>ì¥ë¥´</th>
                                <th>ì¡°íšŒìˆ˜</th>
                                <th>ìˆ˜ìµ</th>
                                <th>ì—…ë¡œë“œì¼</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var content in selectedUserDetail.ContentHistory)
                            {
                                <tr>
                                    <td>@content.Title</td>
                                    <td>@content.Genre</td>
                                    <td>@content.Views.ToString("N0")</td>
                                    <td>@content.Revenue.ToString("N0")</td>
                                    <td>@content.UploadedAt.ToString("yyyy-MM-dd")</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CloseDetailModal">ë‹«ê¸°</button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    private AdminUserListResponse? userList;
    private string searchQuery = "";
    private int currentPage = 1;
    private bool showEditModal = false;
    private bool showDetailModal = false;
    private AdminUserData? selectedUser;
    private AdminUserDetailResponse? selectedUserDetail;
    private long editGold = 0;
    private long editGem = 0;
    private string editReason = "";

    protected override async Task OnInitializedAsync()
    {
        if (!AuthService.IsAuthenticated)
        {
            Navigation.NavigateTo("/login");
            return;
        }

        await LoadUsers();
    }

    private async Task LoadUsers()
    {
        userList = await ApiClient.GetUsersAsync(string.IsNullOrEmpty(searchQuery) ? null : searchQuery, currentPage);
    }

    private async Task SearchUsers()
    {
        currentPage = 1;
        await LoadUsers();
    }

    private async Task LoadPage(int page)
    {
        currentPage = page;
        await LoadUsers();
    }

    private void ShowEditCurrency(AdminUserData user)
    {
        selectedUser = user;
        editGold = 0;
        editGem = 0;
        editReason = "";
        showEditModal = true;
    }

    private void CloseEditModal()
    {
        showEditModal = false;
        selectedUser = null;
    }

    private async Task SaveCurrencyEdit()
    {
        if (selectedUser == null) return;

        var request = new UpdateCurrencyRequest
            {
                Gold = editGold,
                Gem = editGem,
                Reason = editReason
            };

        var success = await ApiClient.UpdateUserCurrencyAsync(selectedUser.UserId, request);
        if (success)
        {
            CloseEditModal();
            await LoadUsers(); // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
        }
    }

    private async Task ViewUserDetail(string userId)
    {
        selectedUserDetail = await ApiClient.GetUserDetailAsync(userId);
        if (selectedUserDetail != null)
        {
            showDetailModal = true;
        }
    }

    private void CloseDetailModal()
    {
        showDetailModal = false;
        selectedUserDetail = null;
    }
}
